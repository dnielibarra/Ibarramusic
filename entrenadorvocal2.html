<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador Vocal Din谩mico</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Tone.js para la generaci贸n de sonido gu铆a -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    
    <style>
        /* Estilos base */
        .vocal-trainer-container {
            background-color: #1f2937; /* Gray 800 */
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border: 1px solid #374151;
        }
        #pitch-canvas {
            background-color: #f7f7f7; /* Fondo de pentagrama blanco/claro */
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            width: 100%; /* Asegurar que el canvas sea responsive */
            height: 150px; /* Altura fija para el pentagrama */
        }
        /* Estilo para el input de radio */
        input[type="radio"]:checked + label {
            background-color: #059669; 
            color: white;
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(5, 150, 105, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-full font-sans p-2 sm:p-4">

    <div class="w-full max-w-lg text-center vocal-trainer-container p-6 sm:p-8">
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-1 text-emerald-400"> Entrenador Vocal Din谩mico</h1>
        <p class="text-gray-400 mb-6 text-sm">Escucha, imita y afina tu voz en el pentagrama.</p>

        <!-- Selecci贸n de Rango Vocal -->
        <div class="mb-6 flex justify-center space-x-3">
            <input type="radio" id="voice-low" name="voice-range" value="low" class="hidden" checked>
            <label for="voice-low" class="flex-1 px-3 py-2 border border-gray-500 rounded-lg cursor-pointer transition-all hover:bg-gray-600 text-sm">Voz Baja (C3-G3)</label>
            
            <input type="radio" id="voice-high" name="voice-range" value="high" class="hidden">
            <label for="voice-high" class="flex-1 px-3 py-2 border border-gray-500 rounded-lg cursor-pointer transition-all hover:bg-gray-600 text-sm">Voz Alta (C4-G4)</label>
        </div>

        <!-- Bot贸n de Inicio y Controles -->
        <button id="start-tuner-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg transition-all shadow-lg mb-4 disabled:bg-gray-600">
            Iniciar Micr贸fono y Tono
        </button>
        <p id="status-message" class="text-sm font-semibold h-4 mb-4 text-yellow-400">Pulsa para iniciar...</p>

        <!-- Contenedor de Pentagrama y Notas -->
        <div class="relative">
            <!-- Canvas para Pentagrama y Bolas de Nota -->
            <canvas id="pitch-canvas" height="150"></canvas>
            
            <!-- Display de Nota y Frecuencia -->
            <div class="flex justify-between items-center px-2">
                <div>
                    <p class="text-sm text-gray-400">Nota a Cantar</p>
                    <div id="target-note" class="text-3xl font-extrabold text-yellow-300">C4</div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500" id="frequency-display">0.0 Hz</p>
                    <div id="detected-note" class="text-xl font-extrabold text-white">---</div>
                    <p class="text-sm text-gray-400">Tu Voz</p>
                </div>
            </div>
        </div>


        <!-- Barra de Progreso Motivacional -->
        <div class="mt-6">
            <p class="text-md font-semibold text-emerald-400 mb-2">Progreso de Estabilidad:</p>
            <div class="w-full bg-gray-600 rounded-full h-8 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-8 bg-emerald-500 transition-all duration-300 ease-out flex items-center justify-center text-sm font-bold text-gray-900" style="width: 0%">
                    0%
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Constantes Musicales y Tareas ---
        const A4_FREQ = 440; 
        const MIDI_A4 = 69;
        const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        // Escala ascendente de 5 notas (C, D, E, F, G)
        const TARGET_MIDI_SCALE_C4 = [60, 62, 64, 65, 67]; 
        
        let currentTargetIndex = 0;
        let targetMidiOffset = 0; // 0 para C4-G4 (Alto), -12 para C3-G3 (Bajo)

        // --- Configuraci贸n de Audio y Detecci贸n ---
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let pitchDetectionInterval = null;
        let synth = null; // Sintetizador para la nota gu铆a

        // --- Variables de Estado y Progreso ---
        let userProgress = 0; 
        const ACCURACY_THRESHOLD = 10; // +/- 10 cents es "perfecto"
        const PROGRESS_RATE = 0.5; 
        const DECAY_RATE = 0.15; 

        // --- Referencias DOM y Canvas ---
        const statusMessage = document.getElementById('status-message');
        const startTunerButton = document.getElementById('start-tuner-button');
        const detectedNoteDisplay = document.getElementById('detected-note');
        const targetNoteDisplay = document.getElementById('target-note');
        const frequencyDisplay = document.getElementById('frequency-display');
        const progressBar = document.getElementById('progress-bar');
        const voiceRangeInputs = document.querySelectorAll('input[name="voice-range"]');
        const canvas = document.getElementById('pitch-canvas');
        const canvasCtx = canvas.getContext('2d');
        let WIDTH = canvas.width;
        let HEIGHT = canvas.height;

        // --- Utilidades Musicales ---
        function freqToMidi(freq) { return MIDI_A4 + (12 * Math.log2(freq / A4_FREQ)); }
        function midiToFreq(midi) { return A4_FREQ * Math.pow(2, (midi - MIDI_A4) / 12); }
        function centsOff(freq, targetFreq) { return 1200 * Math.log2(freq / targetFreq); }
        
        /** Mapea MIDI a posici贸n Y en el pentagrama (ajustado para C4/C3 en el centro del staff) */
        function midiToCanvasY(midi, centerMidi) {
            // Cada l铆nea/espacio es medio tono (6 pasos de semitono por l铆nea)
            // Usaremos C4 (60) o C3 (48) como punto de referencia.
            // Una l铆nea del pentagrama (staff line) debe representar un tono, y un espacio medio tono.
            const totalRangeInCents = 100 * 12; // 12 semitonos, 100 cents cada uno
            const pixelsPerCent = HEIGHT / totalRangeInCents * 4; // Ajuste para visualizaci贸n
            
            // Usamos E4 (64) como l铆nea central del pentagrama para mejor visualizaci贸n
            const staffCenterMidi = centerMidi + 4; // C4(60) -> E4(64), C3(48) -> E3(52)
            const deviation = midi - staffCenterMidi; // Desviaci贸n en semitonos
            
            // 1 semitono = 100 cents. Mapeamos 100 cents a 1/4 de la altura de l铆nea de staff
            const lineHeight = 12; // Altura en p铆xeles de una l铆nea del pentagrama
            const spaceHeight = lineHeight / 2; // Altura de un espacio
            
            // La posici贸n Y se calcula desde el centro del staff, cada semitono mueve la nota.
            const center = HEIGHT / 2;
            
            // Un semitono es 1/2 espacio del pentagrama (la distancia visual)
            // Mapeo inverso: semitonos m谩s altos deben ser Y menor (m谩s arriba)
            const yOffset = -deviation * (spaceHeight / 2); // Ajuste fino del mapeo

            return center + yOffset * 2.5; // Factor de zoom para que se vea bien
        }


        /**
         * Detecci贸n de tono por Autocorrelaci贸n simplificada (robusta).
         */
        function getFundamentalFreq(buffer, sampleRate) {
            const size = buffer.length;
            const threshold = 0.01; // Umbral bajo para voz suave
            let startIndex = 0;

            for (let i = 0; i < size; i++) {
                if (Math.abs(buffer[i]) > threshold) { startIndex = i; break; }
            }
            if (startIndex === 0) return 0;

            let maxCorr = -1;
            let bestPeriod = -1;
            
            // Rango de b煤squeda: 50Hz a 1200Hz
            const minPeriod = sampleRate / 1200; 
            const maxPeriod = sampleRate / 50; 

            for (let tau = Math.floor(minPeriod); tau <= Math.floor(maxPeriod); tau++) {
                let correlation = 0;
                for (let i = startIndex; i < size - tau; i++) {
                    correlation += buffer[i] * buffer[i + tau];
                }
                // Normalizaci贸n de la correlaci贸n (menos estricta)
                let normalizedCorr = correlation / size;

                if (normalizedCorr > maxCorr) {
                    maxCorr = normalizedCorr;
                    bestPeriod = tau;
                }
            }
            
            // Criterio de Calidad: maxCorr debe superar un umbral bajo pero consistente
            if (bestPeriod > 0 && maxCorr > 0.01) { 
                return sampleRate / bestPeriod;
            }
            return 0; 
        }

        // --- L贸gica del Ejercicio y Progreso ---
        
        function updateTargetNote() {
            const targetMidi = TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset;
            const targetFreq = midiToFreq(targetMidi);
            const noteIndex = targetMidi % 12;
            const octave = Math.floor(targetMidi / 12) - 1;
            targetNoteDisplay.textContent = NOTE_NAMES[noteIndex] + octave;

            // Reproducir la nota gu铆a
            if (synth) {
                synth.triggerAttackRelease(NOTE_NAMES[noteIndex] + octave, '8n');
            }

            return targetFreq;
        }

        function updateProgress(cents, isAccurate) {
            
            if (isAccurate) {
                userProgress += PROGRESS_RATE;
                progressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'text-white');
                progressBar.classList.add('bg-emerald-500', 'text-gray-900');
            } else if (Math.abs(cents) <= 30) {
                userProgress += PROGRESS_RATE / 5;
                progressBar.classList.remove('bg-emerald-500', 'bg-red-500', 'text-gray-900');
                progressBar.classList.add('bg-yellow-500', 'text-white');
            } else {
                userProgress -= DECAY_RATE;
                progressBar.classList.remove('bg-emerald-500', 'bg-yellow-500', 'text-gray-900');
                progressBar.classList.add('bg-red-500', 'text-white');
            }

            userProgress = Math.max(0, Math.min(100, userProgress));
            
            progressBar.style.width = `${userProgress.toFixed(0)}%`;
            progressBar.textContent = `${userProgress.toFixed(0)}%`;

            if (userProgress >= 100) {
                userProgress = 0; 
                currentTargetIndex = (currentTargetIndex + 1) % TARGET_MIDI_SCALE_C4.length;
                updateTargetNote(); // Mover a la siguiente nota de la escala
                statusMessage.textContent = '隆Siguiente!  Mant茅n la nota...';
            }
        }

        // --- Funciones de Dibujo (Canvas) ---
        function resizeCanvas() {
            // Asegurar que el canvas tome el ancho completo de su contenedor
            const container = canvas.parentElement.parentElement;
            WIDTH = container.clientWidth;
            canvas.width = WIDTH;
        }

        /**
         * Dibuja el pentagrama y las notas.
         * @param {number} detectedMidi Nota MIDI detectada (redondeada).
         * @param {number} cents Desviaci贸n en cents.
         * @param {boolean} isPlaying Indica si se detect贸 un tono.
         */
        function drawPitchVisual(detectedMidi, cents, isPlaying) {
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
            
            const staffY = HEIGHT / 2; // Centro del pentagrama
            const lineSpacing = 15; // Espacio entre l铆neas del pentagrama
            const noteRadius = 7;
            const centerMidi = targetMidiOffset === 0 ? 60 : 48; // C4 o C3

            // 1. Dibujar las 5 l铆neas del Pentagrama (Staff Lines)
            canvasCtx.strokeStyle = '#000000';
            canvasCtx.lineWidth = 1;
            for (let i = -2; i <= 2; i++) {
                canvasCtx.beginPath();
                canvasCtx.moveTo(0, staffY + i * lineSpacing);
                canvasCtx.lineTo(WIDTH, staffY + i * lineSpacing);
                canvasCtx.stroke();
            }

            const targetMidi = TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset;

            // 2. Dibujar la Nota Objetivo (Fija)
            const targetY = staffY - (targetMidi - centerMidi - 4) * (lineSpacing / 2);
            
            canvasCtx.fillStyle = '#f59e0b'; // Amarillo
            canvasCtx.beginPath();
            canvasCtx.arc(WIDTH / 4, targetY, noteRadius + 2, 0, 2 * Math.PI);
            canvasCtx.fill();
            
            canvasCtx.fillStyle = '#fcd34d'; // Amarillo claro
            canvasCtx.beginPath();
            canvasCtx.arc(WIDTH / 4, targetY, noteRadius, 0, 2 * Math.PI);
            canvasCtx.fill();
            
            canvasCtx.font = 'bold 12px sans-serif';
            canvasCtx.textAlign = 'center';
            canvasCtx.fillStyle = '#1f2937'; 
            canvasCtx.fillText('OBJETIVO', WIDTH / 4, targetY - 15);


            if (isPlaying) {
                // 3. Dibujar la Nota Detectada (Din谩mica, con desviaci贸n vertical)
                
                // Mapear la desviaci贸n de cents (-50 a +50) a un movimiento vertical dentro de un semitono
                let drawCents = Math.min(Math.max(cents, -50), 50); 
                
                // Calcular la posici贸n base MIDI (redondeada) en el pentagrama
                const baseDetectedY = staffY - (detectedMidi - centerMidi - 4) * (lineSpacing / 2);
                
                // Ajustar la posici贸n Y de la nota detectada con la desviaci贸n en cents
                // Cada semitono (lineSpacing/2) es 100 cents.
                const centDeviationY = (-drawCents / 100) * (lineSpacing / 2);
                const finalDetectedY = baseDetectedY + centDeviationY;
                
                let color;
                const absCents = Math.abs(cents);

                if (absCents <= ACCURACY_THRESHOLD) { 
                    color = '#10b981'; // Verde (Afinado)
                } else if (absCents <= 30) { 
                    color = '#f59e0b'; // Amarillo (Cerca)
                } else { 
                    color = '#ef4444'; // Rojo (Desafinado)
                }

                // Dibujar el punto de tono detectado
                canvasCtx.fillStyle = color;
                canvasCtx.shadowColor = color;
                canvasCtx.shadowBlur = 15;
                canvasCtx.beginPath();
                canvasCtx.arc(WIDTH * 0.75, finalDetectedY, noteRadius + 3, 0, 2 * Math.PI);
                canvasCtx.fill();
                canvasCtx.shadowBlur = 0; 

                // Si la nota detectada cae en una l铆nea imaginaria (entre las l铆neas del staff)
                // y est谩 fuera de la octava del pentagrama, no dibujamos l铆neas ledger, solo la bola.
                // Aqu铆 simplificamos el dibujo y solo mostramos la bola.

                canvasCtx.font = 'bold 12px sans-serif';
                canvasCtx.textAlign = 'center';
                canvasCtx.fillStyle = '#ffffff'; 
                canvasCtx.fillText('TU VOZ', WIDTH * 0.75, finalDetectedY - 15);

                
            } else {
                // Silencio o sin detecci贸n clara
                canvasCtx.font = '20px sans-serif';
                canvasCtx.textAlign = 'center';
                canvasCtx.fillStyle = '#6b7280'; 
                canvasCtx.fillText('Canta la nota gu铆a para empezar', WIDTH / 2, staffY + 7);
            }
        }

        // --- Bucle Principal ---
        
        function tick() {
            if (!analyser || !dataArray) {
                pitchDetectionInterval = requestAnimationFrame(tick);
                return;
            }

            analyser.getFloatTimeDomainData(dataArray);
            const sampleRate = audioContext.sampleRate;
            
            const targetFreq = midiToFreq(TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset);
            let detectedFreq = getFundamentalFreq(dataArray, sampleRate);
            let cents = 0;
            let detectedMidi = 0;
            let isPlaying = false;

            if (detectedFreq > 0) {
                isPlaying = true;
                
                cents = centsOff(detectedFreq, targetFreq);
                
                // Actualizar UI de nota
                const rawMidiNote = freqToMidi(detectedFreq);
                detectedMidi = Math.round(rawMidiNote);
                const noteIndex = detectedMidi % 12;
                const octave = Math.floor(detectedMidi / 12) - 1;
                detectedNoteDisplay.textContent = NOTE_NAMES[noteIndex] + octave;
                frequencyDisplay.textContent = `${detectedFreq.toFixed(2)} Hz`;

                // Actualizar Progreso
                updateProgress(cents, Math.abs(cents) <= ACCURACY_THRESHOLD);

            } else {
                // Silencio
                detectedNoteDisplay.textContent = '---';
                frequencyDisplay.textContent = '0.0 Hz';
                detectedMidi = 0; 
                updateProgress(100, false); 
            }

            // Dibujar Canvas
            drawPitchVisual(detectedMidi, cents, isPlaying);
            
            pitchDetectionInterval = requestAnimationFrame(tick);
        }

        // --- Inicializaci贸n y Event Handlers ---

        function handleVoiceRangeChange(event) {
            const range = event.target.value;
            if (range === 'low') {
                targetMidiOffset = -12; // Transponer a C3-G3
            } else {
                targetMidiOffset = 0; // Dejar en C4-G4
            }
            // Resetear
            currentTargetIndex = 0;
            userProgress = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            if (synth) { // Solo actualizar y reproducir si ya est谩 iniciado
                updateTargetNote();
            } else {
                 const targetMidi = TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset;
                 const noteIndex = targetMidi % 12;
                 const octave = Math.floor(targetMidi / 12) - 1;
                 targetNoteDisplay.textContent = NOTE_NAMES[noteIndex] + octave;
            }
        }

        voiceRangeInputs.forEach(input => {
            input.addEventListener('change', handleVoiceRangeChange);
        });

        async function startTuner() {
            startTunerButton.disabled = true;
            statusMessage.textContent = 'Solicitando acceso al micr贸fono y creando sintetizador...';

            try {
                // 1. Inicializar AudioContext (robusto)
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // 2. Inicializar Sintetizador (Tone.js)
                if (!synth) {
                    await Tone.start(); // Iniciar Tone.js
                    synth = new Tone.Synth({
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 1 },
                    }).toDestination();
                }

                // 3. Acceder al Micr贸fono
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; 
                dataArray = new Float32Array(analyser.fftSize);

                source.connect(analyser);

                statusMessage.textContent = 'Micr贸fono activo. 隆Escucha el tono y canta!';
                startTunerButton.textContent = 'Afinador Activo y Tono Gu铆a';
                startTunerButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                startTunerButton.classList.add('bg-emerald-600');
                
                // Iniciar la primera nota (que tambi茅n la reproduce)
                updateTargetNote();

                // Iniciar el bucle de detecci贸n de tono
                tick(); 

            } catch (err) {
                console.error("Error al acceder al micr贸fono:", err);
                statusMessage.textContent = 'Error: No se pudo acceder al micr贸fono o iniciar el audio. (Revisa permisos)';
                statusMessage.classList.remove('text-yellow-400');
                statusMessage.classList.add('text-red-500');
                startTunerButton.disabled = false;
                startTunerButton.textContent = 'Reintentar';
            }
        }

        startTunerButton.addEventListener('click', startTuner);
        
        // Inicializar el tama帽o del canvas y el display de la nota
        window.addEventListener('resize', resizeCanvas);
        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            const targetMidi = TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset;
            const noteIndex = targetMidi % 12;
            const octave = Math.floor(targetMidi / 12) - 1;
            targetNoteDisplay.textContent = NOTE_NAMES[noteIndex] + octave;
        });

    </script>
</body>
</html>
