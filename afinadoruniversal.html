<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinador Universal Estable (Guitarra y Ukelele)</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥n de fuente y contenedores */
        .tuner-container {
            background-color: #1f2937; /* Gray 800 */
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border: 1px solid #374151;
            max-width: 500px; 
            min-height: 500px;
        }
        
        /* Estilo para el medidor de cents (aguja) */
        #meter-needle {
            transform-origin: 50% 100%;
            transition: transform 0.1s ease-out; /* Suaviza el movimiento */
        }

        /* Colores del dial */
        .meter-line {
            stroke: #4b5563; /* Gris */
        }
        .meter-center {
            stroke: #10b981; /* Verde esmeralda (Afinado) */
        }
        .meter-sides {
            stroke: #f59e0b; /* Amarillo (Cerca) */
        }
        .meter-far {
            stroke: #ef4444; /* Rojo (Lejos) */
        }

        /* Animaci√≥n de estado del micr√≥fono */
        .mic-status-off {
             animation: pulse-red 1s infinite;
        }
        .mic-status-on {
             animation: pulse-green 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }

        /* Estilo para los botones de cuerda/instrumento */
        .tuning-btn {
            @apply p-2 sm:p-3 rounded-xl font-bold transition-all duration-200 shadow-lg text-sm sm:text-lg;
            background-color: #374151; /* Gray 700 */
            color: #d1d5db; /* Gray 300 */
        }
        .tuning-btn.selected {
            background-color: #059669; /* Emerald 600 */
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.6);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-full font-sans p-2 sm:p-4">

    <div class="w-full tuner-container p-6 sm:p-8">
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-1 text-emerald-400 text-center">Tuner Universal üé∏üá∫üá¶</h1>
        <p class="text-gray-400 mb-4 text-sm text-center">Guitarra y Ukelele. Afinaci√≥n m√°s estable.</p>

        <!-- Selecci√≥n de Instrumento -->
        <div class="flex justify-center space-x-4 mb-6">
            <button id="select-guitar" class="tuning-btn selected">Guitarra</button>
            <button id="select-ukulele" class="tuning-btn">Ukelele</button>
        </div>

        <!-- Bot√≥n de Inicio y Controles -->
        <div class="flex flex-col items-center mb-6">
            <button id="start-tuner-button" class="w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg transition-all shadow-xl disabled:bg-gray-600 mb-3">
                Iniciar Micr√≥fono
            </button>
            <div class="flex items-center">
                <div id="mic-status-light" class="w-4 h-4 rounded-full bg-red-500 mic-status-off transition-all"></div>
                <p id="status-message" class="text-xs font-semibold ml-2 text-yellow-400">Pulsa para iniciar la detecci√≥n de tono...</p>
            </div>
        </div>

        <!-- Visualizador de Cents (Dial) -->
        <div class="flex flex-col items-center">
            <div id="note-display" class="text-6xl sm:text-8xl font-extrabold mb-2 text-white transition-colors duration-300">E2</div>
            <div id="frequency-display" class="text-xl text-gray-400 mb-4">--- Hz</div>
            
            <svg id="tuner-meter" width="300" height="180" viewBox="0 0 300 180" class="w-full max-w-sm">
                <!-- Arcos del dial -->
                <path d="M 50 150 A 100 100 0 0 1 250 150" fill="none" class="meter-line" stroke-width="20" stroke-linecap="round"/>
                
                <!-- Centro (Verde - Afinado) -->
                <path d="M 125 150 A 100 100 0 0 1 175 150" fill="none" class="meter-center" stroke-width="20" stroke-linecap="butt"/>
                
                <!-- Lados (Amarillo - Cerca) -->
                <path d="M 85 150 A 100 100 0 0 1 125 150" fill="none" class="meter-sides" stroke-width="20" stroke-linecap="butt"/>
                <path d="M 175 150 A 100 100 0 0 1 215 150" fill="none" class="meter-sides" stroke-width="20" stroke-linecap="butt"/>

                <!-- Puntos de referencia -->
                <circle cx="150" cy="150" r="5" fill="#ffffff"/>
                <circle cx="100" cy="150" r="3" fill="#ffffff"/>
                <circle cx="200" cy="150" r="3" fill="#ffffff"/>
                <circle cx="65" cy="150" r="3" fill="#ffffff"/>
                <circle cx="235" cy="150" r="3" fill="#ffffff"/>

                <!-- Etiquetas de Cents -->
                <text x="55" y="165" fill="#d1d5db" font-size="12" text-anchor="middle">-50</text>
                <text x="245" y="165" fill="#d1d5db" font-size="12" text-anchor="middle">+50</text>
                
                <!-- Aguja (Pivota desde (150, 150)) -->
                <line id="meter-needle" x1="150" y1="150" x2="150" y2="50" stroke="#fefefe" stroke-width="4" stroke-linecap="round"/>
            </svg>
        </div>

        <!-- Botones de Cuerdas Din√°micos -->
        <div id="string-buttons-container" class="flex justify-center space-x-2 mt-4 flex-wrap gap-y-2">
            <!-- Los botones se insertar√°n aqu√≠ por JavaScript -->
        </div>

    </div>

    <script>
        // --- Constantes Musicales y Afinaciones ---
        const A4_FREQ = 440; 
        const MIDI_A4 = 69;
        
        // Afinaciones (MIDI en orden de la cuerda m√°s grave a la m√°s aguda)
        const TUNINGS = {
            'guitar': {
                name: 'Guitarra',
                notes: [40, 45, 50, 55, 59, 64], // E2, A2, D3, G3, B3, E4
                names: ['E2', 'A2', 'D3', 'G3', 'B3', 'E4']
            },
            'ukulele': {
                name: 'Ukelele (GCEA)',
                notes: [67, 60, 64, 69], // G4, C4, E4, A4 (G-c-e-a)
                names: ['G4', 'C4', 'E4', 'A4']
            }
        };

        // --- Configuraci√≥n de Audio y Detecci√≥n ---
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let mediaStream = null;
        let animationFrameId = null;

        // --- Variables de Estado del Afinador ---
        let isTunerRunning = false;
        let currentInstrument = 'guitar'; 
        let currentStringIndex = 0;

        // Estabilidad y Precisi√≥n
        const ACCURACY_THRESHOLD = 8; // +/- 8 cents (para el color verde)
        // ** VALORES AJUSTADOS PARA MAYOR ESTABILIDAD (STICKINESS) **
        const PROGRESS_RATE_STICKY = 3.0; // Velocidad de aumento (hace que el verde se "pegue")
        const DECAY_RATE = 0.3; // Velocidad de disminuci√≥n

        // Estado interno para el progreso de afinaci√≥n
        let greenPersistence = 0; // 0 a 100

        // --- Referencias DOM ---
        const statusMessage = document.getElementById('status-message');
        const startTunerButton = document.getElementById('start-tuner-button');
        const noteDisplay = document.getElementById('note-display');
        const frequencyDisplay = document.getElementById('frequency-display');
        const micStatusLight = document.getElementById('mic-status-light');
        const stringButtonsContainer = document.getElementById('string-buttons-container');
        const meterNeedle = document.getElementById('meter-needle');

        // --- Utilidades Musicales ---

        /** Convierte frecuencia a nota MIDI */
        function freqToMidi(freq) { return MIDI_A4 + (12 * Math.log2(freq / A4_FREQ)); }
        
        /** Convierte MIDI a frecuencia */
        function midiToFreq(midi) { return A4_FREQ * Math.pow(2, (midi - MIDI_A4) / 12); }
        
        /** Calcula la desviaci√≥n en cents */
        function centsOff(freq, targetFreq) { return 1200 * Math.log2(freq / targetFreq); }

        /**
         * Detecci√≥n de tono usando Autocorrelaci√≥n simplificada.
         * (Optimizado para funcionar bien en el rango de guitarra/ukelele)
         */
        function getFundamentalFreq(buffer, sampleRate) {
            const size = buffer.length;
            const threshold = 0.05; 
            let startIndex = 0;

            // Encontrar el primer punto de amplitud suficiente
            for (let i = 0; i < size; i++) {
                if (Math.abs(buffer[i]) > threshold) { startIndex = i; break; }
            }
            if (startIndex === 0 || size - startIndex < 100) return 0; // Silencio o se√±al muy d√©bil

            let maxCorr = -1;
            let bestPeriod = -1;
            
            // Rango de frecuencias de 50 Hz (E1/Ukulele grave) a 1200 Hz (Arm√≥nico alto)
            const minPeriod = sampleRate / 1200; 
            const maxPeriod = sampleRate / 50; 

            for (let tau = Math.floor(minPeriod); tau <= Math.floor(maxPeriod); tau++) {
                let correlation = 0;
                for (let i = startIndex; i < size - tau; i++) {
                    correlation += buffer[i] * buffer[i + tau];
                }
                let normalizedCorr = correlation / (size - tau); // Normalizaci√≥n mejorada

                if (normalizedCorr > maxCorr) {
                    maxCorr = normalizedCorr;
                    bestPeriod = tau;
                }
            }
            
            // Usamos un umbral de correlaci√≥n m√°s alto para evitar ruido
            if (bestPeriod > 0 && maxCorr > 0.1) { 
                return sampleRate / bestPeriod;
            }
            return 0; 
        }
        
        // --- L√≥gica de la Interfaz ---

        function getTarget() {
            const notes = TUNINGS[currentInstrument].notes;
            const names = TUNINGS[currentInstrument].names;
            const midi = notes[currentStringIndex];
            
            return {
                midi: midi,
                freq: midiToFreq(midi),
                name: names[currentStringIndex]
            };
        }

        function updateStringButtons() {
            stringButtonsContainer.innerHTML = '';
            const tuning = TUNINGS[currentInstrument];
            
            tuning.names.forEach((name, index) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.classList.add('tuning-btn');
                
                if (index === currentStringIndex) {
                    button.classList.add('selected');
                }
                
                button.dataset.index = index;
                button.onclick = () => {
                    currentStringIndex = index;
                    // Resetear la persistencia al cambiar de cuerda para evitar confusi√≥n
                    greenPersistence = 0; 
                    updateDisplay(0, 0, false); 
                    updateStringButtons(); 
                };
                stringButtonsContainer.appendChild(button);
            });

            // Actualizar la nota objetivo principal
            noteDisplay.textContent = tuning.names[currentStringIndex];
            noteDisplay.classList.add('text-white');
            noteDisplay.classList.remove('text-emerald-400', 'text-yellow-400', 'text-red-400');
        }

        function updateDisplay(cents, detectedFreq, isPlaying) {
            // 1. Actualizar Frecuencia
            frequencyDisplay.textContent = isPlaying ? `${detectedFreq.toFixed(2)} Hz` : '--- Hz';

            // 2. L√≥gica de Persistencia (Stickiness)
            let isAccurate = isPlaying && Math.abs(cents) <= ACCURACY_THRESHOLD;
            
            if (isAccurate) {
                // Aumenta la persistencia r√°pidamente si est√° afinado
                greenPersistence = Math.min(100, greenPersistence + PROGRESS_RATE_STICKY);
            } else if (isPlaying) {
                 // Disminuye lentamente si est√° cantando, pero fuera del rango 'pegado'
                greenPersistence = Math.max(0, greenPersistence - DECAY_RATE);
            } else {
                 // Disminuye m√°s r√°pido si hay silencio o no hay detecci√≥n (para que vuelva a empezar)
                greenPersistence = Math.max(0, greenPersistence - (DECAY_RATE * 1.5));
            }
            
            const isGreenSticky = greenPersistence > 50; 

            // 3. Ajustar la Aguja (Needle)
            // Clamp a +/- 50 cents para la visualizaci√≥n del dial
            const clampedCents = Math.min(Math.max(cents, -50), 50); 
            // Rango de rotaci√≥n: -45 grados (muy bajo) a +45 grados (muy alto)
            const rotation = (clampedCents / 50) * 45; 
            meterNeedle.style.transform = `rotate(${rotation}deg)`;
            
            // 4. Actualizar Color de la Nota
            let colorClass;
            
            if (isGreenSticky) {
                colorClass = 'text-emerald-400';
            } else if (isPlaying && Math.abs(cents) <= 20) {
                colorClass = 'text-yellow-400';
            } else if (isPlaying) {
                colorClass = 'text-red-400';
            } else {
                colorClass = 'text-white';
            }

            const currentTargetName = getTarget().name;

            // Solo actualizar si el estado cambi√≥ o si la nota no coincide
            if (!noteDisplay.classList.contains(colorClass) || noteDisplay.textContent !== currentTargetName) {
                noteDisplay.className = `text-6xl sm:text-8xl font-extrabold mb-2 transition-colors duration-300 ${colorClass}`;
                noteDisplay.textContent = currentTargetName;
            }
            
            if (isGreenSticky) {
                statusMessage.textContent = `¬°AFINADO! ‚úÖ Peristencia: ${greenPersistence.toFixed(0)}%`;
                statusMessage.classList.add('text-emerald-400');
                statusMessage.classList.remove('text-yellow-400', 'text-red-400');
            } else if (isPlaying) {
                statusMessage.textContent = `${cents.toFixed(1)} cents`;
                 statusMessage.classList.remove('text-emerald-400');
                 statusMessage.classList.add(Math.abs(cents) <= 20 ? 'text-yellow-400' : 'text-red-400');
            } else {
                statusMessage.textContent = 'Micr√≥fono activo. Toca la cuerda.';
                statusMessage.classList.add('text-yellow-400');
                statusMessage.classList.remove('text-emerald-400', 'text-red-400');
            }
        }
        
        // --- Bucle Principal de Detecci√≥n ---

        function tick() {
            if (!isTunerRunning || !analyser || !dataArray) {
                animationFrameId = requestAnimationFrame(tick);
                return;
            }

            const target = getTarget();
            analyser.getFloatTimeDomainData(dataArray);
            const sampleRate = audioContext.sampleRate;
            
            let detectedFreq = getFundamentalFreq(dataArray, sampleRate);
            let cents = 0;
            let isPlaying = detectedFreq > 0;

            if (isPlaying) {
                // Calcular la desviaci√≥n de la frecuencia objetivo
                cents = centsOff(detectedFreq, target.freq);
                
                // Actualizar la interfaz
                updateDisplay(cents, detectedFreq, true);

            } else {
                // Silencio o Detecci√≥n fallida
                updateDisplay(0, 0, false);
            }

            animationFrameId = requestAnimationFrame(tick);
        }

        // --- Inicializaci√≥n y Event Handlers ---

        async function initAudioContext() {
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            } catch (err) {
                 console.error("Error al inicializar el AudioContext:", err);
            }
        }

        async function startTuner() {
            if (isTunerRunning) return;

            startTunerButton.disabled = true;
            statusMessage.textContent = 'Iniciando micr√≥fono...';
            startTunerButton.textContent = 'Iniciando...';
            
            await initAudioContext();

            try {
                // Acceder al Micr√≥fono
                if (!mediaStream) {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096; // Mayor FFT size para mejor resoluci√≥n de baja frecuencia
                dataArray = new Float32Array(analyser.fftSize);

                source.connect(analyser);
                
                isTunerRunning = true;
                statusMessage.textContent = '¬°Micr√≥fono Activo! Toca la cuerda.';
                startTunerButton.textContent = 'Afinador Activo';
                startTunerButton.classList.remove('bg-blue-600');
                startTunerButton.classList.add('bg-emerald-600');
                micStatusLight.classList.remove('bg-red-500', 'mic-status-off');
                micStatusLight.classList.add('bg-emerald-500', 'mic-status-on');

                // Iniciar el bucle de detecci√≥n de tono
                if (!animationFrameId) {
                    tick(); 
                }

            } catch (err) {
                console.error("Error al acceder al micr√≥fono:", err);
                statusMessage.textContent = `ERROR: Acceso al micr√≥fono denegado. Aseg√∫rate de tener permisos.`;
                statusMessage.classList.remove('text-yellow-400');
                statusMessage.classList.add('text-red-500');
                startTunerButton.disabled = false;
                startTunerButton.textContent = 'Reintentar Micr√≥fono';
                micStatusLight.classList.remove('bg-emerald-500', 'mic-status-on');
                micStatusLight.classList.add('bg-red-500', 'mic-status-off');
            }
        }

        function setInstrument(instrumentKey) {
            document.getElementById(`select-${currentInstrument}`).classList.remove('selected');
            currentInstrument = instrumentKey;
            document.getElementById(`select-${currentInstrument}`).classList.add('selected');
            
            // Reiniciar estado
            currentStringIndex = 0;
            greenPersistence = 0; 
            
            updateStringButtons();
            updateDisplay(0, 0, false);
        }

        // --- Event Listeners Globales ---
        startTunerButton.addEventListener('click', startTuner);
        document.getElementById('select-guitar').addEventListener('click', () => setInstrument('guitar'));
        document.getElementById('select-ukulele').addEventListener('click', () => setInstrument('ukulele'));

        // Inicializaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer el instrumento inicial y actualizar botones
            setInstrument('guitar');
            // Iniciar el bucle de renderizado para mostrar la UI vac√≠a
            tick(); 
        });

    </script>
</body>
</html>
