<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador Vocal Estable V3</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Tone.js para la generaci贸n de sonido gu铆a -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    
    <style>
        /* Estilos base */
        .vocal-trainer-container {
            background-color: #1f2937; /* Gray 800 */
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border: 1px solid #374151;
            max-width: 480px; /* Tama帽o m谩ximo para centrar en escritorio */
        }
        #pitch-canvas {
            background-color: #f7f7f7; /* Fondo de pentagrama blanco/claro */
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            width: 100%; 
            height: 150px; 
        }
        /* Estilo para el input de radio */
        input[type="radio"]:checked + label {
            background-color: #059669; 
            color: white;
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(5, 150, 105, 0.5);
        }
        .mic-status-off {
             animation: pulse-red 1s infinite;
        }
        .mic-status-on {
             animation: pulse-green 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-full font-sans p-2 sm:p-4">

    <div class="w-full vocal-trainer-container p-6 sm:p-8">
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-1 text-emerald-400"> Entrenador Vocal Din谩mico V3</h1>
        <p class="text-gray-400 mb-4 text-sm">Afinaci贸n con sonido gu铆a y visualizaci贸n de tu voz en tiempo real.</p>

        <!-- Selecci贸n de Rango Vocal -->
        <div class="mb-4 flex justify-center space-x-3">
            <input type="radio" id="voice-low" name="voice-range" value="-12" class="hidden" checked>
            <label for="voice-low" class="flex-1 px-3 py-2 border border-gray-500 rounded-lg cursor-pointer transition-all hover:bg-gray-600 text-sm">Voz Baja (C3-G3)</label>
            
            <input type="radio" id="voice-high" name="voice-range" value="0" class="hidden">
            <label for="voice-high" class="flex-1 px-3 py-2 border border-gray-500 rounded-lg cursor-pointer transition-all hover:bg-gray-600 text-sm">Voz Alta (C4-G4)</label>
        </div>

        <!-- Bot贸n de Inicio y Controles -->
        <button id="start-tuner-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg transition-all shadow-lg mb-2 disabled:bg-gray-600">
            Iniciar Micr贸fono y Tono Gu铆a
        </button>
        <div class="flex items-center justify-between mb-4">
            <div id="mic-status-light" class="w-4 h-4 rounded-full bg-red-500 mic-status-off transition-all"></div>
            <p id="status-message" class="text-sm font-semibold h-4 text-yellow-400 text-left flex-1 ml-2">Pulsa para iniciar el audio...</p>
            <button id="play-tone-button" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-full text-xs transition-colors shadow-md disabled:opacity-50" disabled>
                Escuchar Tono
            </button>
        </div>

        <!-- Contenedor de Pentagrama y Notas -->
        <div class="relative">
            <canvas id="pitch-canvas" height="150"></canvas>
            
            <!-- Display de Nota y Frecuencia -->
            <div class="flex justify-between items-center px-2">
                <div>
                    <p class="text-sm text-gray-400">Nota Objetivo</p>
                    <div id="target-note" class="text-3xl font-extrabold text-yellow-300">C3</div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500" id="frequency-display">0.0 Hz</p>
                    <div id="detected-note" class="text-xl font-extrabold text-white">---</div>
                    <p class="text-sm text-gray-400">Tu Voz Detectada</p>
                </div>
            </div>
        </div>

        <!-- Barra de Progreso Motivacional -->
        <div class="mt-6">
            <p class="text-md font-semibold text-emerald-400 mb-2">Estabilidad de Afinaci贸n:</p>
            <div class="w-full bg-gray-600 rounded-full h-8 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-8 bg-emerald-500 transition-all duration-300 ease-out flex items-center justify-center text-sm font-bold text-gray-900" style="width: 0%">
                    0%
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Constantes Musicales y Tareas ---
        const A4_FREQ = 440; 
        const MIDI_A4 = 69;
        const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        // Escala ascendente de 5 notas: C, D, E, F, G (MIDI 60, 62, 64, 65, 67)
        const TARGET_MIDI_SCALE_C4 = [60, 62, 64, 65, 67]; 
        
        let currentTargetIndex = 0;
        let targetMidiOffset = -12; // Inicia en C3 (Voz Baja)
        let isTunerRunning = false;

        // --- Configuraci贸n de Audio y Detecci贸n ---
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let synth = null; 
        let mediaStream = null;

        // --- Variables de Estado y Progreso ---
        let userProgress = 0; 
        const ACCURACY_THRESHOLD = 10; // +/- 10 cents (d茅cimas de semitono)
        const PROGRESS_RATE = 0.5; 
        const DECAY_RATE = 0.15; 

        // --- Referencias DOM y Canvas ---
        const statusMessage = document.getElementById('status-message');
        const startTunerButton = document.getElementById('start-tuner-button');
        const playToneButton = document.getElementById('play-tone-button');
        const detectedNoteDisplay = document.getElementById('detected-note');
        const targetNoteDisplay = document.getElementById('target-note');
        const frequencyDisplay = document.getElementById('frequency-display');
        const progressBar = document.getElementById('progress-bar');
        const voiceRangeInputs = document.querySelectorAll('input[name="voice-range"]');
        const micStatusLight = document.getElementById('mic-status-light');
        const canvas = document.getElementById('pitch-canvas');
        const canvasCtx = canvas.getContext('2d');
        let WIDTH = canvas.width;
        let HEIGHT = canvas.height;

        // --- Utilidades Musicales ---
        function freqToMidi(freq) { return MIDI_A4 + (12 * Math.log2(freq / A4_FREQ)); }
        function midiToFreq(midi) { return A4_FREQ * Math.pow(2, (midi - MIDI_A4) / 12); }
        function centsOff(freq, targetFreq) { return 1200 * Math.log2(freq / targetFreq); }
        
        /** Convierte MIDI a string de nota (Ej: 60 -> C4) */
        function midiToNoteString(midi) {
            const noteIndex = midi % 12;
            const octave = Math.floor(midi / 12) - 1;
            return NOTE_NAMES[noteIndex] + octave;
        }

        /**
         * Detecci贸n de tono por Autocorrelaci贸n simplificada.
         */
        function getFundamentalFreq(buffer, sampleRate) {
            // Implementaci贸n de Autocorrelaci贸n (mismo c贸digo que V2)
            const size = buffer.length;
            const threshold = 0.01; 
            let startIndex = 0;

            for (let i = 0; i < size; i++) {
                if (Math.abs(buffer[i]) > threshold) { startIndex = i; break; }
            }
            if (startIndex === 0) return 0;

            let maxCorr = -1;
            let bestPeriod = -1;
            const minPeriod = sampleRate / 1200; 
            const maxPeriod = sampleRate / 50; 

            for (let tau = Math.floor(minPeriod); tau <= Math.floor(maxPeriod); tau++) {
                let correlation = 0;
                for (let i = startIndex; i < size - tau; i++) {
                    correlation += buffer[i] * buffer[i + tau];
                }
                let normalizedCorr = correlation / size;

                if (normalizedCorr > maxCorr) {
                    maxCorr = normalizedCorr;
                    bestPeriod = tau;
                }
            }
            
            if (bestPeriod > 0 && maxCorr > 0.01) { 
                return sampleRate / bestPeriod;
            }
            return 0; 
        }

        // --- L贸gica del Ejercicio y Progreso ---
        
        function getCurrentTargetNote() {
            const targetMidi = TARGET_MIDI_SCALE_C4[currentTargetIndex] + targetMidiOffset;
            return {
                midi: targetMidi,
                freq: midiToFreq(targetMidi),
                name: midiToNoteString(targetMidi)
            };
        }

        function playTargetNote() {
            const target = getCurrentTargetNote();
            if (synth) {
                 // Usa el nombre de la nota calculado
                synth.triggerAttackRelease(target.name, '1n'); 
                console.log(`Reproduciendo nota gu铆a: ${target.name}`);
            }
        }

        function updateTargetUI() {
            const target = getCurrentTargetNote();
            targetNoteDisplay.textContent = target.name;
        }
        
        function updateProgress(cents, isAccurate) {
            
            if (isAccurate) {
                userProgress += PROGRESS_RATE;
                progressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'text-white');
                progressBar.classList.add('bg-emerald-500', 'text-gray-900');
            } else if (Math.abs(cents) <= 30) {
                userProgress += PROGRESS_RATE / 5;
                progressBar.classList.remove('bg-emerald-500', 'bg-red-500', 'text-gray-900');
                progressBar.classList.add('bg-yellow-500', 'text-white');
            } else {
                userProgress -= DECAY_RATE;
                progressBar.classList.remove('bg-emerald-500', 'bg-yellow-500', 'text-gray-900');
                progressBar.classList.add('bg-red-500', 'text-white');
            }

            userProgress = Math.max(0, Math.min(100, userProgress));
            
            progressBar.style.width = `${userProgress.toFixed(0)}%`;
            progressBar.textContent = `${userProgress.toFixed(0)}%`;

            if (userProgress >= 100) {
                userProgress = 0; 
                currentTargetIndex = (currentTargetIndex + 1) % TARGET_MIDI_SCALE_C4.length;
                updateTargetUI(); // Actualiza la UI antes de reproducir
                playTargetNote(); // Reproduce la nueva nota
                statusMessage.textContent = '隆Siguiente!  Mant茅n la afinaci贸n...';
            }
        }

        // --- Funciones de Dibujo (Canvas) ---
        function resizeCanvas() {
            const container = canvas.parentElement.parentElement;
            WIDTH = container.clientWidth;
            canvas.width = WIDTH;
        }

        function drawPitchVisual(detectedMidi, cents, isPlaying) {
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
            
            const staffY = HEIGHT / 2; 
            const lineSpacing = 15; 
            const noteRadius = 7;
            const target = getCurrentTargetNote();
            const centerMidi = targetMidiOffset === 0 ? 60 : 48; // C4 o C3 como referencia

            // 1. Dibujar las 5 l铆neas del Pentagrama (Staff Lines)
            canvasCtx.strokeStyle = '#000000';
            canvasCtx.lineWidth = 1;
            for (let i = -2; i <= 2; i++) {
                canvasCtx.beginPath();
                canvasCtx.moveTo(0, staffY + i * lineSpacing);
                canvasCtx.lineTo(WIDTH, staffY + i * lineSpacing);
                canvasCtx.stroke();
            }

            // 2. Dibujar la Nota Objetivo (Fija)
            // Calculamos la posici贸n Y. +4 es para centrar la visualizaci贸n en la l铆nea E (mi)
            const targetY = staffY - (target.midi - centerMidi - 4) * (lineSpacing / 2);
            
            canvasCtx.fillStyle = '#f59e0b'; // Amarillo (borde)
            canvasCtx.beginPath();
            canvasCtx.arc(WIDTH / 4, targetY, noteRadius + 2, 0, 2 * Math.PI);
            canvasCtx.fill();
            
            canvasCtx.fillStyle = '#fcd34d'; // Amarillo claro (relleno)
            canvasCtx.beginPath();
            canvasCtx.arc(WIDTH / 4, targetY, noteRadius, 0, 2 * Math.PI);
            canvasCtx.fill();
            
            canvasCtx.font = 'bold 12px sans-serif';
            canvasCtx.textAlign = 'center';
            canvasCtx.fillStyle = '#1f2937'; 
            canvasCtx.fillText(target.name, WIDTH / 4, targetY - 15);


            if (isPlaying) {
                // 3. Dibujar la Nota Detectada (Din谩mica, con desviaci贸n vertical)
                
                let drawCents = Math.min(Math.max(cents, -50), 50); // Clamping para un semitono de visualizaci贸n
                
                // Posici贸n base de la nota detectada (redondeada al semitono m谩s cercano)
                const baseDetectedY = staffY - (detectedMidi - centerMidi - 4) * (lineSpacing / 2);
                
                // Ajustar posici贸n Y por la desviaci贸n en cents
                const centDeviationY = (-drawCents / 100) * (lineSpacing / 2);
                const finalDetectedY = baseDetectedY + centDeviationY;
                
                let color;
                const absCents = Math.abs(cents);

                if (absCents <= ACCURACY_THRESHOLD) { 
                    color = '#10b981'; // Verde (Afinado)
                } else if (absCents <= 30) { 
                    color = '#f59e0b'; // Amarillo (Cerca)
                } else { 
                    color = '#ef4444'; // Rojo (Desafinado)
                }

                // Dibujar el punto de tono detectado
                canvasCtx.fillStyle = color;
                canvasCtx.shadowColor = color;
                canvasCtx.shadowBlur = 15;
                canvasCtx.beginPath();
                canvasCtx.arc(WIDTH * 0.75, finalDetectedY, noteRadius + 3, 0, 2 * Math.PI);
                canvasCtx.fill();
                canvasCtx.shadowBlur = 0; 

                canvasCtx.font = 'bold 12px sans-serif';
                canvasCtx.textAlign = 'center';
                canvasCtx.fillStyle = '#ffffff'; 
                canvasCtx.fillText(midiToNoteString(detectedMidi), WIDTH * 0.75, finalDetectedY - 15);

                
            } else if (isTunerRunning) {
                // Micr贸fono activo pero sin sonido
                 canvasCtx.font = '18px sans-serif';
                canvasCtx.textAlign = 'center';
                canvasCtx.fillStyle = '#6b7280'; 
                canvasCtx.fillText('Esperando tu voz...', WIDTH / 2, staffY + 7);
            }
        }

        // --- Bucle Principal ---
        
        function tick() {
            if (!isTunerRunning || !analyser || !dataArray) {
                requestAnimationFrame(tick);
                return;
            }

            const target = getCurrentTargetNote();
            analyser.getFloatTimeDomainData(dataArray);
            const sampleRate = audioContext.sampleRate;
            
            let detectedFreq = getFundamentalFreq(dataArray, sampleRate);
            let cents = 0;
            let detectedMidi = 0;
            let isPlaying = false;

            if (detectedFreq > 0) {
                isPlaying = true;
                
                cents = centsOff(detectedFreq, target.freq);
                
                const rawMidiNote = freqToMidi(detectedFreq);
                detectedMidi = Math.round(rawMidiNote);
                
                frequencyDisplay.textContent = `${detectedFreq.toFixed(2)} Hz`;

                // Actualizar Progreso
                updateProgress(cents, Math.abs(cents) <= ACCURACY_THRESHOLD);

            } else {
                // Silencio
                detectedNoteDisplay.textContent = '---';
                frequencyDisplay.textContent = '0.0 Hz';
                detectedMidi = 0; 
                // El progreso decae solo si no hay detecci贸n clara
                updateProgress(100, false); 
            }

            // Dibujar Canvas
            drawPitchVisual(detectedMidi, cents, isPlaying);
            
            requestAnimationFrame(tick);
        }

        // --- Inicializaci贸n y Event Handlers ---

        function handleVoiceRangeChange(event) {
            // El valor es el offset MIDI
            targetMidiOffset = parseInt(event.target.value, 10); 
            
            // Resetear
            currentTargetIndex = 0;
            userProgress = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            updateTargetUI();

            // Si el afinador ya est谩 corriendo, reproducir la nueva nota gu铆a
            if (isTunerRunning && synth) { 
                playTargetNote();
            }
        }

        voiceRangeInputs.forEach(input => {
            input.addEventListener('change', handleVoiceRangeChange);
        });
        
        playToneButton.addEventListener('click', () => {
             // Iniciar Tone.js en el primer click si no se ha hecho
            if (!synth) {
                initAudioContext();
            }
            playTargetNote();
        });


        async function initAudioContext() {
            // Inicializar AudioContext y Tone.js
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                if (!synth) {
                    await Tone.start(); // Iniciar Tone.js
                    synth = new Tone.Synth({
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 1 },
                    }).toDestination();
                }
                playToneButton.disabled = false;
                
            } catch (err) {
                 console.error("Error al inicializar el AudioContext o Tone.js:", err);
            }
        }


        async function startTuner() {
            if (isTunerRunning) return;

            startTunerButton.disabled = true;
            statusMessage.textContent = 'Iniciando micr贸fono...';
            startTunerButton.textContent = 'Iniciando...';
            
            // 1. Asegurar Contexto de Audio
            await initAudioContext();

            try {
                // 2. Acceder al Micr贸fono
                if (!mediaStream) {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; 
                dataArray = new Float32Array(analyser.fftSize);

                source.connect(analyser);
                
                isTunerRunning = true;
                statusMessage.textContent = '隆Micr贸fono Activo! Tono Gu铆a listo.';
                startTunerButton.textContent = 'Afinador Activo';
                startTunerButton.classList.remove('bg-blue-600');
                startTunerButton.classList.add('bg-emerald-600');
                micStatusLight.classList.remove('bg-red-500', 'mic-status-off');
                micStatusLight.classList.add('bg-emerald-500', 'mic-status-on');

                // Iniciar la primera nota (que tambi茅n la reproduce)
                updateTargetUI();
                playTargetNote();

                // Iniciar el bucle de detecci贸n de tono
                tick(); 

            } catch (err) {
                console.error("Error al acceder al micr贸fono:", err);
                statusMessage.textContent = `ERROR: Acceso al micr贸fono denegado. Aseg煤rate de tener permisos. Detalles: ${err.name}`;
                statusMessage.classList.remove('text-yellow-400');
                statusMessage.classList.add('text-red-500');
                startTunerButton.disabled = false;
                startTunerButton.textContent = 'Reintentar Micr贸fono';
            }
        }

        startTunerButton.addEventListener('click', startTuner);
        
        // Inicializar el tama帽o del canvas y el display de la nota inicial (C3)
        window.addEventListener('resize', resizeCanvas);
        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            // Inicializar el offset y la UI
            handleVoiceRangeChange({ target: { value: '-12' } }); 
            // Iniciar el bucle de renderizado del canvas inmediatamente (para dibujar staff)
            requestAnimationFrame(tick);
        });

    </script>
</body>
</html>